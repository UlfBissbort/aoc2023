use std::collections::{HashMap, HashSet};


const TEST_DATA: &str = "\
#.#####################
#.......#########...###
#######.#########.#.###
###.....#.>.>.###.#.###
###v#####.#v#.###.#.###
###.>...#.#.#.....#...#
###v###.#.#.#########.#
###...#.#.#.......#...#
#####.#.#.#######.#.###
#.....#.#.#.......#...#
#.#####.#.#.#########v#
#.#...#...#...###...>.#
#.#.#v#######v###.###v#
#...#.>.#...>.>.#.###.#
#####v#.#.###v#.#.###.#
#.....#...#...#.#.#...#
#.#########.###.#.#.###
#...###...#...#...#.###
###.###.#.###v#####v###
#...#...#.#.>.>.#.>.###
#.###.###.#.###.#.#v###
#.....###...###...#...#
#####################.#\
";

const DATA: &str = "\
#.###########################################################################################################################################
#...#...###...#.....#.............#...#...#...#####...#.....###...#...........#.....#.............#...#...#...#...........#.............#...#
###.#.#.###.#.#.###.#.###########.#.#.#.#.#.#.#####.#.#.###.###.#.#.#########.#.###.#.###########.#.#.#.#.#.#.#.#########.#.###########.#.#.#
###.#.#.#...#.#.#...#.#...#.......#.#.#.#.#.#...#...#.#...#.###.#.#...#.......#...#.#.....#.......#.#.#.#...#.#.........#...#...........#.#.#
###.#.#.#.###.#.#v###.#.#.#.#######.#.#.#.#.###.#.###.###.#.###.#.###.#.#########.#.#####.#.#######.#.#.#####.#########.#####.###########.#.#
#...#.#...###...#.>.#...#.#.#...###.#.#.#.#...#.#.#...#...#...#.#...#.#.........#.#.#...#.#.......#.#.#.....#.###...###...#...###.........#.#
#.###.###########v#.#####.#.#.#.###.#.#.#.###.#.#.#.###.#####.#.###.#.#########.#.#.#.#.#.#######.#.#.#####.#.###.#.#####.#.#####.#########.#
#...#.#...........#.#...#.#.#.#.>.>.#.#.#.#...#.#.#.###.....#.#.#...#.#.........#.#...#...#.......#.#...###.#.#...#.#.....#.......#.........#
###.#.#.###########.#.#.#.#.#.###v###.#.#.#.###.#.#.#######.#.#.#.###.#.#########.#########.#######.###.###.#.#.###.#.#############.#########
###...#...#.......#...#.#.#...###...#...#.#...#...#...#.....#...#.#...#...###...#.......#...###...#...#.#...#.#...#.#.....#.........#...#####
#########.#.#####.#####.#.#########.#####.###.#######.#.#########.#.#####.###.#.#######.#.#####.#.###.#.#.###.###.#.#####.#.#########.#.#####
#.......#...#...#.....#.#.#.......#...###...#.#.......#.....#...#...#.....#...#...#.....#.....#.#.#...#...#...#...#.....#.#...#...#...#...###
#.#####.#####.#.#####.#.#.#.#####.###.#####.#.#.###########.#.#.#####.#####.#####.#.#########.#.#.#.#######.###.#######.#.###.#.#.#.#####.###
#.....#.......#.......#...#.#...#.....#...#...#.........#...#.#.#.....#...#.....#.#.....#.....#.#.#.....#...###.......#.#...#.#.#...#...#...#
#####.#####################.#.#.#######.#.#############.#.###.#.#.#####.#.#####.#.#####.#.#####.#.#####.#.###########.#.###.#.#.#####.#.###.#
#...#...#.................#...#.......#.#.....###.......#...#.#.#.#...#.#.###...#.#...#.#...#...#.#...#.#...#.>.>...#.#.#...#.#.###...#...#.#
#.#.###.#.###############.###########.#.#####.###.#########.#.#.#.#.#.#.#.###.###.#.#.#.###.#.###.#.#.#.###.#.#v###.#.#.#.###.#.###.#####.#.#
#.#...#...#.......#.......#...........#.###...#...#...#...#...#.#.#.#.#.#.>.>.###.#.#...###...#...#.#.#...#.#.#.###.#.#...#...#.#...#...#.#.#
#.###.#####.#####.#.#######.###########.###.###.###.#.#.#.#####.#.#.#.#.###v#####.#.###########.###.#.###.#.#.#.###.#.#####.###.#.###.#.#.#.#
#...#.#...#.....#.#.......#.......#.....#...###.....#.#.#.>.>...#.#.#...#...#...#.#.....###...#...#.#...#.#...#...#.#...#...#...#.....#.#.#.#
###.#.#.#.#####.#.#######.#######.#.#####.###########.#.###v#####.#.#####.###.#.#.#####.###.#.###.#.###.#.#######.#.###.#.###.#########.#.#.#
#...#...#.......#...#...#.#.......#.#...#...........#.#...#...###.#.....#...#.#.#.......#...#.###...###...###...#.#.....#.....#.........#...#
#.#################.#.#.#.#.#######.#.#.###########.#.###.###.###.#####.###.#.#.#########.###.###############.#.#.#############.#############
#.................#...#.#.#.....#...#.#.........#...#.#...###...#.#.....#...#.#...#.......#...#.....#.....#...#.#...#...###...#.............#
#################.#####.#.#####.#.###.#########.#.###.#.#######.#.#.#####.###.###.#.#######.###.###.#.###.#.###.###.#.#.###.#.#############.#
###...###...#...#.....#...#...#...#...#.....###...#...#.#.......#...#...#...#.#...#.......#.....#...#...#...###.....#.#...#.#...............#
###.#.###.#.#.#.#####.#####.#.#####.###.###.#######.###.#.###########.#.###.#.#.#########.#######.#####.#############.###.#.#################
#...#.....#...#.......#...#.#.......#...###.....###.....#.........#...#.###...#...#...###...#.....#...#...#...#...###.#...#.....#...........#
#.#####################.#.#.#########.#########.#################.#.###.#########.#.#.#####.#.#####.#.###v#.#.#.#.###.#.#######.#.#########.#
#.#...#...#...###...###.#.#.........#.#.........#...###.....#.....#.#...#...###...#.#.#...#.#.#...#.#.#.>.>.#.#.#...#.#.....###...#.........#
#.#.#.#.#.#.#.###.#.###.#.#########.#.#.#########.#.###.###.#.#####.#.###.#.###v###.#.#.#.#.#.#.#.#.#.#.#v###.#.###.#.#####.#######.#########
#...#...#...#...#.#.....#.#####...#.#.#.....#.....#...#...#.#.#...#.#...#.#...>.>.#.#...#.#.#.#.#.#.#...#.#...#.#...#.....#...#...#.........#
###############.#.#######.#####.#.#.#.#####.#.#######.###.#.#v#.#.#.###.#.#####v#.#.#####.#.#.#.#.#.#####.#.###.#.#######.###.#.#.#########.#
#.....#.....#...#.#.......#.....#.#...#.....#.#.......#...#.>.>.#...###...###...#.#...#...#.#...#.#.#.....#.#...#...#...#.#...#.#.........#.#
#.###.#.###.#v###.#.#######.#####.#####.#####.#.#######.#####v###############.###.###.#.###.#####.#.#.#####.#.#####.#.#.#.#.###.#########.#.#
#...#.#.#...#.>.#.#.......#.....#...###.......#.....###.....#.....###.........###.#...#...#.....#...#.....#.#...#...#.#...#...#.#.......#...#
###.#.#.#.###v#.#.#######.#####.###.###############.#######.#####.###.###########.#.#####.#####.#########.#.###.#.###.#######.#.#.#####.#####
#...#...#.#...#.#.#.......#.....#...#...###.........#...#...#...#...#...........#.#.#.....#...#.#.........#.....#.....###...#.#...#...#.....#
#.#######.#.###.#.#.#######.#####.###.#.###.#########.#.#.###.#.###.###########.#.#.#.#####.#.#.#.#######################.#.#.#####.#.#####.#
#.......#...###...#...#...#...#...#...#.#...#.....###.#.#.#...#.....#...........#...#...#...#...#.#.......#...###.........#...#...#.#.......#
#######.#############.#.#.###.#.###.###.#.###.###.###.#.#.#.#########.#################.#.#######.#.#####.#.#.###.#############.#.#v#########
###...#.........#.....#.#...#.#.###.#...#...#...#.#...#...#.........#...............###...#.....#...#...#.#.#...#.#.....#.....#.#.>.#.....###
###.#.#########.#.#####.###.#.#.###.#.#####v###.#.#.###############.###############.#######.###.#####.#.#.#.###.#.#.###.#.###.#.###v#.###.###
#...#.#.........#.....#.###.#.#.#...#.#...>.>.#.#.#...#.......#...#.#...............#.....#.#...#.....#.#...#...#...#...#...#.#...#.#...#...#
#.###.#.#############.#.###.#.#.#.###.#.###v#.#.#.###.#.#####.#.#.#.#.###############.###.#.#.###.#####.#####.#######.#####.#.###.#.###.###.#
#...#.#.............#.#.#...#.#.#.#...#.#...#...#...#.#.....#...#...#.......#.....###...#...#...#.....#...###.......#.......#.#...#...#.#...#
###.#.#############.#.#.#.###.#.#.#.###.#.#########.#.#####.###############.#.###.#####.#######.#####.###.#########.#########.#.#####.#.#.###
#...#.......#.......#...#...#.#.#.#.#...#.....#####.#.#.....#.......#######.#.#...#...#.......#.#####...#...........###.......#.....#...#...#
#.#########.#.#############.#.#.#.#.#.#######.#####.#.#.#####.#####.#######.#.#.###.#.#######.#.#######.###############.###########.#######.#
#.#...#...#.#.............#...#...#...#.....#.....#.#.#.......#.....#.......#.#...#.#...#...#.#...#...#...........#...#...#.........#.......#
#.#.#.#.#.#.#############.#############.###.#####.#.#.#########.#####.#######.###.#.###.#.#.#.###.#.#.###########.#.#.###.#.#########.#######
#.#.#...#.#.#...#.......#.#.......#...#...#.......#...#.........#...#.......#...#.#.#...#.#.#.#...#.#.#...###.....#.#...#...#...#...#.....###
#.#.#####.#.#.#.#.#####.#.#.#####.#.#.###.#############.#########.#.#######.###.#.#.#.###.#.#.#.###.#.#.#.###v#####.###.#####.#.#.#.#####.###
#...#.....#.#.#...#...#...#.....#.#.#.###...........###.........#.#.........#...#.#.#...#.#.#.#.#...#.#.#.#.>.>...#.#...###...#.#.#.....#...#
#####.#####.#.#####.#.#########.#.#.#.#############.###########.#.###########.###.#.###.#.#.#.#.#.###.#.#.#.#v###.#.#.#####.###.#.#####.###.#
#...#.....#.#...###.#.###...###.#.#.#.#...........#.#...........#...........#...#.#.###.#.#.#.#.#...#.#.#.#.#.#...#.#.#...#...#.#.#.....#...#
#.#.#####.#.###.###.#.###.#.###.#.#.#.#.#########.#.#.#####################.###.#.#.###.#.#.#.#.###.#.#.#.#.#.#.###.#.#.#.###.#.#.#.#####v###
#.#.#.....#.....#...#.#...#...#.#...#.#.....#...#...#.............#.......#.###.#...#...#.#.#.#.#...#...#...#.#.#...#.#.#...#.#.#.#...#.>.###
#.#.#.###########.###.#.#####.#.#####.#####.#.#.#################.#.#####.#v###.#####.###.#.#.#.#.###########.#.#.###.#.###.#.#.#.###.#.#v###
#.#...#.....#...#.#...#.....#.#.....#.###...#.#...#...#.........#.#.....#.>.>...#...#.....#.#.#.#.#.......#...#...###.#.#...#.#...###...#.###
#.#####.###.#.#.#.#.#######.#.#####.#.###v###.###.#.#.#.#######.#.#####.###v#####.#.#######.#.#.#.#.#####.#.#########.#.#.###.###########.###
#...#...#...#.#.#.#.#.....#.#...#...#...>.>.#.#...#.#.#.......#.#.###...###.#.....#.......#...#...#.....#...#.....#...#.#...#...#...#...#...#
###.#.###v###.#.#.#.#.###.#.###.#.#######v#.#.#.###.#.#######.#.#.###.#####.#.###########.#############.#####.###.#.###.###.###.#.#.#.#.###.#
#...#.###.>...#...#.#.#...#.#...#...#.....#...#...#.#.#.......#...#...#.....#.#...........###...#.......#.....#...#...#.###...#.#.#...#.....#
#.###.###v#########.#.#.###.#.#####.#.###########.#.#.#.###########.###.#####.#.#############.#.#.#######.#####.#####.#.#####.#.#.###########
#.#...#...#.....###...#.#...#...#...#...........#...#.#.....#...#...###.......#...........#...#.#...#...#.#.....#####.#.#.....#.#...#.....###
#.#.###.###.###.#######.#.#####.#.#############.#####.#####v#.#.#.#######################.#.###.###.#.#.#.#.#########.#.#.#####.###.#.###.###
#.#.#...#...###.......#...###...#.#.............#.....#...>.>.#...#...#...........#.....#.#.#...#...#.#.#.#.........#.#.#...#...###...###...#
#.#.#.###.###########.#######.###.#.#############.#####.###v#######.#.#.#########.#.###.#.#.#.###.###.#.#.#########.#.#.###.#.#############.#
#...#.....#...#...#...#.....#.....#...........#...#.....###.........#.#.........#...###...#.#.###.....#...#.........#...###...#.............#
###########.#.#.#.#.###.###.#################.#.###.#################.#########.###########.#.#############.###################.#############
#...###.....#.#.#...###...#.....#...###...#...#.....###...#.....#.....#...#...#.#...#...#...#...#.......#...#...#.....###.....#.............#
#.#.###.#####.#.#########.#####.#.#.###.#.#.###########.#.#.###.#.#####.#.#.#.#.#.#.#.#.#.#####.#.#####.#.###.#.#.###.###.###.#############.#
#.#.....#...#...#...#...#.#.....#.#.....#.#...#...###...#...#...#.#.....#.#.#.#...#.#.#.#...#...#.....#.#.....#...#...#...#...#.......#.....#
#.#######.#.#####.#.#.#.#.#.#####v#######.###.#.#.###.#######.###.#.#####.#.#.#####.#.#.###.#.#######.#.###########.###.###.###.#####.#.#####
#.#.......#.....#.#.#.#.#.#.#...>.>.....#.....#.#.#...#...###.....#.....#.#.#.......#.#...#.#.#...#...#.#...#.......###...#...#.....#.#.....#
#.#.###########v#.#.#.#.#.#.#.###v#####.#######.#.#.###.#.#############.#.#.#########.###.#.#.#.#.#.###.#.#.#.###########.###.#####.#.#####.#
#.#...#.......#.>.#.#.#.#.#.#.###.....#.#...###.#.#.....#.#...###...###.#.#.....#...#...#.#.#.#.#.#...#.#.#.#...#...#...#.#...#.....#.#.....#
#.###.#.#####.#v###.#.#.#.#.#.#######.#.#.#.###.#.#######v#.#.###.#.###.#.#####v#.#.###.#.#.#.#.#.###.#.#.#.###v#.#.#.#.#.#.###.#####.#.#####
#.....#.....#.#...#.#.#.#.#.#.#...#...#...#.#...#.#...#.>.>.#...#.#.#...#...#.>.>.#...#.#.#.#.#.#...#.#.#.#.#.>.>.#...#.#.#.###.....#.#...###
###########.#.###.#.#.#.#.#.#.#.#.#.#######.#.###.#.#.#.#v#####.#.#.#.#####.#.#v#####.#.#.#.#.#.###.#.#.#.#.#.#v#######.#.#.#######.#.###.###
#...........#.#...#...#...#...#.#.#.###.....#...#.#.#.#.#...###...#.#.#.....#.#.....#.#.#.#.#.#.###.#.#...#...#.......#.#.#...#...#.#...#...#
#.###########.#.###############.#.#.###.#######.#.#.#.#.###.#######.#.#.#####.#####.#.#.#.#.#.#.###.#.###############.#.#.###.#.#.#.###.###.#
#...........#.#.......#.........#...#...#...#...#.#.#...###.......#...#.....#.#.....#.#.#.#.#.#...#.#.#.........#.....#.#.#...#.#.#.#...#...#
###########.#.#######.#.#############.###.#.#.###.#.#############.#########.#.#.#####.#.#.#.#.###.#.#.#.#######.#.#####.#.#.###.#.#.#.###v###
#...........#...#.....#.............#...#.#.#...#...#...........#.......#...#.#.....#.#.#.#.#.#...#...#.......#.#.....#...#...#.#.#.#...>.###
#.#############.#.#################.###.#.#.###.#####.#########.#######.#.###.#####.#.#.#.#.#.#.#############.#.#####.#######.#.#.#.#####v###
#.............#...#.........#.......###.#.#...#.....#.#...#...#.........#.....#.....#...#...#...###.....#...#.#.......#.......#.#.#.###...###
#############.#####.#######.#.#########.#.###.#####.#.#.#.#.#.#################.###################.###.#.#.#.#########.#######.#.#.###.#####
###.......#...#...#.......#.#...###...#...###.......#...#...#...#.....#.....#...###...#...#####...#...#...#...#.......#.......#.#.#.#...#...#
###.#####.#.###.#.#######.#.###.###.#.#########################.#.###.#.###.#.#####.#.#.#.#####.#.###.#########.#####.#######.#.#.#.#.###.#.#
#...#...#...#...#...#.....#...#.....#...#...###.......#...#.....#.#...#...#.#.......#.#.#...###.#.###.#...#.....#.....#.....#.#.#...#.....#.#
#.###.#.#####.#####.#.#######.#########.#.#.###.#####.#.#.#.#####.#.#####.#.#########.#.###.###.#.###.#.#.#.#####.#####.###.#.#.###########.#
#.....#.......#.....#.#.....#...........#.#.#...#.....#.#.#.....#.#.#...#.#.......#...#...#.....#...#...#...#...#...#...#...#...###.........#
###############.#####.#.###.#############.#.#.###.#####.#.#####.#.#.#.#.#.#######.#.#####.#########.#########.#.###.#.###.#########.#########
#...............#...#...###.........#...#.#.#.#...###...#.......#.#.#.#.#.......#.#.#...#.......#...#...#.....#.....#...#.#...#...#.........#
#.###############.#.###############.#.#.#.#.#.#.#####.###########.#.#.#.#######.#.#.#.#.#######.#.###.#.#.#############.#.#.#.#.#.#########.#
#...#...#.........#...#.....###...#...#.#.#.#.#.....#...#.......#.#.#.#.#...#...#...#.#.#.....#.#...#.#.#.......#...###.#.#.#.#.#.#####...#.#
###.#.#.#.###########.#.###.###.#.#####.#.#.#.#####.###.#.#####.#.#.#.#.#.#.#v#######.#.#.###.#.###.#.#.#######.#.#.###.#.#.#.#.#.#####v#.#.#
###...#.#.#...........#...#.#...#.......#.#.#.#.....#...#.#.....#.#...#...#.>.>...###.#.#...#.#.#...#.#.#...#...#.#...#.#.#.#.#.#...#.>.#.#.#
#######.#.#.#############.#.#.###########.#.#.#.#####.###.#.#####.###########v###.###.#.###.#.#.#.###.#.#.#.#v###.###.#.#.#.#.#.###.#.#v#.#.#
###...#...#.......#...#...#.#...#...#...#.#.#.#.#...#.....#...###.........###...#.#...#.#...#.#.#...#.#...#.>.>.#...#.#.#.#.#.#.###...#.#...#
###.#.###########.#.#.#.###.###.#.#.#.#.#.#.#.#.#.#.#########v###########.#####.#.#.###.#.###.#.###.#.#######v#.###.#.#.#.#.#.#.#######.#####
#...#.............#.#.#...#.....#.#.#.#.#.#.#.#.#.#.#...#...>.>.#...#...#.#.....#...#...#...#...###...#...#...#.#...#...#.#.#.#.#.....#...###
#.#################.#.###.#######.#.#.#.#.#.#.#.#.#.#.#.#.###v#.#.#.#.#.#.#.#########.#####.###########.#.#.###.#.#######.#.#.#.#.###.###.###
#.#.....#...###...#.#.###.......#.#...#...#...#.#.#...#.#.#...#...#.#.#...#.......###...#...#.........#.#.#...#.#.....#...#.#...#...#...#...#
#.#.###.#.#v###.#.#.#.#########.#.#############.#.#####.#.#.#######.#.###########.#####.#.###.#######.#.#.###.#.#####.#.###.#######.###.###.#
#...###...#.>.#.#.#.#.#...#.....#.......###.....#.#.....#.#.#...###...###...#...#.#...#...###...#...#.#.#.....#.#...#.#.....###...#...#.#...#
###########v#.#.#.#.#.#.#.#.###########.###.#####.#.#####.#.#.#.#########.#.#.#.#.#.#.#########.#.#.#.#.#######.#.#.#.#########.#.###.#.#.###
#...........#.#.#.#.#.#.#.#.....#.....#...#.....#.#.#...#.#...#.......#...#...#...#.#.....#...#...#.#.#.......#.#.#...#.........#.....#.#...#
#.###########.#.#.#.#.#.#.#####v#.###.###.#####.#.#.#.#.#.###########.#.###########.#####.#.#.#####.#.#######.#.#.#####.###############.###.#
#...........#.#.#.#.#.#.#.#...>.>.###.#...#.....#.#...#...#...........#.....#.....#.#.....#.#.......#.........#...#...#...............#.....#
###########.#.#.#.#.#.#.#.#.###v#####.#.###.#####.#########.###############.#.###.#.#.#####.#######################.#.###############.#######
#...........#...#...#.#.#...###.#...#...###...#...#...#.....###...#...#####...###...#.....#...............#...#...#.#.#...#...#.......###...#
#.###################.#.#######.#.#.#########.#.###.#.#.#######.#.#.#.###################.###############.#.#.#.#.#.#.#.#.#.#.#.#########.#.#
#.............#...###...###.....#.#.#.......#...###.#.#.....###.#...#.....#.............#.#.............#.#.#.#.#.#.#.#.#...#...#...#...#.#.#
#############.#.#.#########.#####.#.#.#####.#######.#.#####.###.#########.#.###########.#.#.###########.#.#.#.#.#.#.#.#.#########.#.#.#.#.#.#
#.............#.#.........#.......#...#.....###...#.#.#...#.....#...#.....#...........#...#...#.......#...#.#.#.#.#.#.#.........#.#.#.#.#.#.#
#.#############.#########.#############.#######.#.#.#.#.#.#######.#.#.###############.#######.#.#####.#####.#.#.#.#.#.#########.#.#.#.#.#.#.#
#...#...#.....#.#.........#...#.......#.......#.#.#.#...#.........#.#...#...#.........#...###...#.....###...#.#.#.#.#.....#...#...#...#...#.#
###.#.#.#.###.#.#.#########.#.#.#####.#######.#.#.#.###############.###.#.#.#.#########.#.#######.#######.###.#.#.#.#####.#.#.#############.#
###...#...#...#.#.....#.....#.#.....#.#...#...#.#...#.............#.#...#.#.#...........#.......#...#...#...#.#.#.#...#...#.#.#.............#
###########.###.#####.#.#####.#####.#.#.#.#.###.#####.###########.#.#.###.#.###################.###.#.#.###.#.#.#.###.#.###.#.#v#############
#...........#...###...#.....#.......#...#...###.#...#.#...........#...###.#...###.......#.......###...#.#...#.#.#...#.#.#...#.>.###...#.....#
#.###########.#####.#######.###################.#.#.#.#.#################.###.###.#####.#.#############.#.###.#.###.#.#.#.#####v###.#.#.###.#
#...........#.#.....###.....#...#...###...#...#...#...#.................#...#...#.....#...#.............#...#...#...#.#.#.....#...#.#.#.#...#
###########.#.#.#######.#####.#.#.#.###.#.#.#.#########################.###.###.#####.#####.###############.#####.###.#.#####.###.#.#.#.#.###
###...#.....#.#.......#.#...#.#...#.....#...#...#...#...............#...###...#.#####.....#...........#...#.....#.....#.#.....###...#...#...#
###.#.#.#####.#######.#.#.#.#.#################.#.#.#.#############.#.#######.#.#########.###########.#.#.#####.#######.#.#################.#
#...#...#...#.#.......#...#...#...###...........#.#.#.............#...###...#.#...#.......###.........#.#.....#.#.......#.###.............#.#
#.#######.#.#.#.###############.#.###v###########.#.#############.#######.#.#.###.#.#########.#########.#####.#.#.#######.###.###########.#.#
#.....#...#...#.....#.....#...#.#.#.>.>...#...###.#.###...#.......#...#...#.#.#...#.........#.........#.....#.#.#.#.....#.#...#...###...#...#
#####.#.###########.#.###.#.#.#.#.#.#####.#.#.###.#.###.#.#v#######.#.#.###.#.#.###########.#########.#####.#.#.#.#.###.#.#.###.#.###.#.#####
#.....#.#...........#...#...#.#.#...#.....#.#...#.#.#...#.>.>.#...#.#.#...#.#.#.#####.......###...#...#.....#...#.#...#.#.#...#.#.#...#.#...#
#.#####.#.#############.#####.#.#####.#####.###.#.#.#.#######.#.#.#.#.###.#.#.#.#####v#########.#.#v###.#########.###.#.#.###.#.#.#.###.#.#.#
#.#...#.#.#...#...#...#.....#.#.....#.....#...#.#.#.#.....###.#.#.#.#.#...#.#.#...#.>.>.#...#...#.>.>.#.........#.#...#...###...#...###.#.#.#
#.#.#.#.#.#.#.#.#.#.#.#####.#.#####.#####.###.#.#.#.#####.###.#.#.#.#.#.###.#.###.#.###.#.#.#.#######.#########.#.#.###################.#.#.#
#.#.#.#.#.#.#.#.#.#.#.#...#.#...#...#.....#...#.#.#...#...#...#.#.#.#.#...#.#...#.#...#.#.#.#.......#.#.........#.#...#.................#.#.#
#.#.#.#.#.#.#.#.#.#.#.#.#.#.###.#.###.#####.###.#.###.#.###.###.#.#.#.###.#.###.#.###.#.#.#.#######.#.#.#########.###.#.#################.#.#
#...#...#...#...#...#...#...###...###.......###...###...###.....#...#.....#.....#.....#...#.........#...#########.....#...................#.#
###########################################################################################################################################.#\
";


#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash, PartialOrd, Ord)]
struct Pos(u16, u16);

#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash)]
enum Tile {
    Entrace,
    Exit,
    Walkable,
    Wall,
    Right,
    Left,
    Up,
    Down,    
}

trait ToTile {
    fn to_tile(&self) -> Tile;
}

impl ToTile for (usize, usize, char) {
    fn to_tile(&self) -> Tile {
        let (m, m_max, c) = self;
        match (m, m_max, c) {
            (_, _, '#') => Tile::Wall,
            (_, _, _) if *m == 0 => Tile::Entrace,
            (_, _, _) if *m == (m_max-1) => Tile::Exit,
            (_, _, '.') => Tile::Walkable,
            (_, _, '>') => Tile::Right,
            (_, _, '<') => Tile::Left,
            (_, _, '^') => Tile::Up,
            (_, _, 'v') => Tile::Down,            
            _ => panic!("Unknown tile: {:?}", self),
        }
    }
}

#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash)]
struct Segment(Pos, Pos);

impl Segment {
    // uniqueness ensured by valid segment states being ordered
    fn new(pos1: Pos, pos2: Pos) -> Self {
        if pos1 < pos2 {
            Self(pos1, pos2)
        } else {
            Self(pos2, pos1)
        }
    }
}


#[derive(Debug)]
struct State {
    junction_pts: HashMap<Pos, Vec<(Pos, u16)>>,     // value: (other side of segment, path length)
    todos: Vec<(Pos, Pos)>,                     // (prev_pos, pos) pairs: start of new paths to explore
    current_segment: Option<Vec<Pos>>,          // current segment being explored
    m_max: usize,
    explored_segments: HashSet<(Pos, Pos)>,    // pos_prev, pos
}





fn main() {
    // let data = TEST_DATA;
    let data = DATA;

    // time this function
    let t0 = std::time::Instant::now();
    solve(data, ok_to_walk_part_1);
    let t1 = std::time::Instant::now();
    println!("⏱️  Time taken for Part 1: {:?}\n\n", t1 - t0);

    let t0 = std::time::Instant::now();
    solve(data, ok_to_walk_part_2);
    let t1 = std::time::Instant::now();
    println!("⏱️  Time taken for Part 2: {:?}\n\n", t1 - t0);
}


type Sig = fn(Pos, Pos, &HashMap<Pos, Tile>) -> bool;

fn solve(data: &str, ok_to_walk: Sig) {
    let m_max = data.lines().count();

    // create a hashmap Pos(m, n) => Tile
    // Only insert walkable tiles
    let tiles: HashMap<Pos, Tile> = data.split('\n')
    .enumerate()
    .flat_map(|(m, line)| {
        line.chars()
            .enumerate()
            .map(move |(n, c)| (Pos(m as u16, n as u16), (m, m_max, c).to_tile()))
            .filter(|&(_, tile)| tile != Tile::Wall)
    })
    .collect();
    
    let exit = *tiles.iter().filter(|(_, &tile)| tile == Tile::Exit).next().unwrap().0;
 
    let mut state = State{
        junction_pts: HashMap::new(),
        todos: vec![(  // populate graph crawler with initial state
            Pos(0, 0),   
            *tiles.keys().filter(|&Pos(m, _)| {*m == 0} ).next().unwrap()  // there must be one start state at m=0
        )],
        current_segment: None,
        m_max: m_max,
        explored_segments: HashSet::new(),
    };
    let mut keep_going = true;

    while keep_going {
        (state, keep_going) = match state {
            // if there is a current path being explored, continue exploring it
            _ if state.current_segment != None =>(continue_segment(state, &tiles, ok_to_walk), true),
            // if there is no current path, start exploring a new one from the todo list if it is not empty
            _ if !state.todos.is_empty() => (process_todo_item(state, &tiles), true),
            _ => (state, false),
        };
    }
    
    let mut junction_pts_vec = state.junction_pts.iter().collect::<Vec<_>>();
    junction_pts_vec.sort_by(|e1, e2| e1.0.cmp(e2.0));
    junction_pts_vec.iter().for_each(|(pos, v)| println!("🌿 {:?} -> {:?}", pos, v));


    // ***** tree search for longest path *****

    // representation of ONE path along the maze: a vector of Pos. Puzzle rule: a pos may never repeat along one path
    // iterate a family of paths: each path is a vector of Pos
    let mut paths = Paths{
        completed: Vec::new(),
        in_progress: vec![Path(vec![Pos(0, 0)], 0)],
    };

    while !paths.in_progress.is_empty() {
        paths = take_steps(paths, &state.junction_pts, exit);
    }

    paths.completed.sort_by(|p1, p2| p2.1.cmp(&p1.1));
    paths.completed.iter().take(5).for_each(|path| println!("👉 {:?}", path));
    println!("total no of paths: {}", paths.completed.len());


}


/// add the next step for each path in the tree search step procedure
fn take_steps(mut paths: Paths, junction_pts: &HashMap<Pos, Vec<(Pos, u16)>>, exit: Pos) -> Paths {
    let mut new_paths = Vec::new();
    let mut new_completed = Vec::new();

    for path in paths.in_progress.iter() {
        let next_pt_candidates = junction_pts.get(&path.0[path.0.len()-1]).unwrap();
        for cand in next_pt_candidates.iter() {
            if !path.0.contains(&cand.0) {
                let mut new_path = path.0.clone();
                new_path.push(cand.0);

                match cand.0 == exit {
                    true => new_completed.push(Path(new_path, path.1 + cand.1 as u32)),  // also add the lengths
                    false => new_paths.push(Path(new_path, path.1 + cand.1 as u32)),
                }
            }
        }
    }

    paths.completed.extend(new_completed);
    paths.in_progress = new_paths;
    paths
}


#[derive(Debug)]
struct Path(Vec<Pos>, u32); // (junction_pts, total_length)


#[derive(Debug)]
struct Paths {
    completed: Vec<Path>,
    in_progress: Vec<Path>,
}


/// are we allowed to walk along this step?
fn ok_to_walk_part_1(prev_pos: Pos, pos: Pos, tiles: &HashMap<Pos, Tile>) -> bool {
    let Pos(m, n) = pos;
    let Pos(prev_m, prev_n) = prev_pos;

    match (m, m as i32 - prev_m as i32, n as i32 - prev_n as i32, tiles.get(&prev_pos)) {        
        (0, _, _, _) => true, // from entrance: first step is always ok
        (_, _, _, Some(Tile::Walkable | Tile::Exit | Tile::Entrace)) => true,
        (_, 0, 1, Some(Tile::Right)) => true,
        (_, 0, -1, Some(Tile::Left)) => true,
        (_, 1, 0, Some(Tile::Down)) => true,
        (_, -1, 0, Some(Tile::Up)) => true,
        _ => false,
    }
}

/// are we allowed to walk along this step?
/// There are no restrictions for part 2
fn ok_to_walk_part_2(prev_pos: Pos, pos: Pos, tiles: &HashMap<Pos, Tile>) -> bool {
    true
}


fn continue_segment(mut state: State, tiles: &HashMap<Pos, Tile>, ok_to_walk: Sig) -> State {
    // get the last two elements of the vector
    let (prev_pos, pos) = 
    if let Some(ref v) = state.current_segment {
        let len = v.len();
        (v[len-2], v[len-1])
    } else { 
        unreachable!() 
    };

    if !ok_to_walk(prev_pos, pos, tiles) {  // abandon this path
        state.current_segment = None;
        return state;
    }

    let moves = potential_move(prev_pos, pos, tiles);

    match moves.len() {
        0 => State{  // dead end. Do not add to junction_pts
            current_segment: None,
            ..state
        },
        1 if tiles[&moves[0]] == Tile::Exit => {   // we have reached the exit
            let end_pos = moves[0];
            let seg_length = state.current_segment.as_ref().unwrap().len() as u16 - 1;    // is this the right length??? 🧨
            let seg_start_pos = state.current_segment.as_ref().unwrap()[0];

            println!("🦖🌿 end reached end_pos: {:?}, seg_length: {}, seg_start_pos: {:?}", end_pos, seg_length, seg_start_pos);

            // add the current segment to the junction_pts hashmap: check if the start pos is already in the hashmap
            if let Some(v) = state.junction_pts.get_mut(&seg_start_pos) {
                // only push if the segment is not already in the vector
                if !v.iter().any(|(p, _)| *p == pos) {
                    v.push((end_pos, seg_length));
                }
            } else {
                state.junction_pts.insert(seg_start_pos, vec![(end_pos, seg_length)]);
            };
            state.current_segment = None;
            state            
        },
        1 => {  // continue exploring the current segment            
            state.current_segment.get_or_insert_with(Vec::new).push(moves[0]);            
            state
        },
        _ => {  // we have reached a junction point
            state.todos.extend(moves.iter().map(|&next_pos| (pos, next_pos)));
            
            let seg_length = state.current_segment.as_ref().unwrap().len() as u16 - 1;    // is this the right length??? 🧨
            let seg_start_pos = state.current_segment.as_ref().unwrap()[0];

            // add the current segment to the junction_pts hashmap: check if the start pos is already in the hashmap
            if let Some(v) = state.junction_pts.get_mut(&seg_start_pos) {
                // only push if the segment is not already in the vector
                if !v.iter().any(|(p, _)| *p == pos) {
                    v.push((pos, seg_length));
                }
            } else {
                state.junction_pts.insert(seg_start_pos, vec![(pos, seg_length)]);
            };
            state.current_segment = None;
            
            state
        }        
    }    
}

// it could be that the next todo item was already done: if the segment is already in the explored_segments set
fn process_todo_item(mut state: State, _tiles: &HashMap<Pos, Tile>) -> State {
    debug_assert_eq!(state.current_segment, None);
    while !state.todos.is_empty() {
        let (prev_pos, pos) = state.todos.pop().unwrap();
        if !state.explored_segments.contains(&(prev_pos, pos)) {
            state.explored_segments.insert((prev_pos, pos));
            state.current_segment = Some(vec![prev_pos, pos]);
            return state;
        }
    }
    state
}


/// this also includes other incoming segments: i.e. which we cannot move ONTO
/// from the junction point. But we need to know that they are there to split the segment
fn potential_move(prev_pos: Pos, pos: Pos, tiles: &HashMap<Pos, Tile>) -> Vec<Pos> {
    let mut moves = Vec::new();
    let Pos(m, n) = pos;
    let Pos(prev_m, prev_n) = prev_pos;

    if m>0 && m-1 != prev_m {
        if let Some(_) = tiles.get(&Pos(m-1, n)) {
            moves.push(Pos(m-1, n));
        }
    }
    if m+1 != prev_m {
        if let Some(_) = tiles.get(&Pos(m+1, n)) {
            moves.push(Pos(m+1, n));
        }
    }
    if n>0 && n-1 != prev_n {
        if let Some(_) = tiles.get(&Pos(m, n-1)) {
            moves.push(Pos(m, n-1));
        }
    }
    if n+1 != prev_n {
        if let Some(_) = tiles.get(&Pos(m, n+1)) {
            moves.push(Pos(m, n+1));
        }
    }

    moves
}
